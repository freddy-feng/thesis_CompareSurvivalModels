---
title: "comparison"
author: "Yibin Feng"
date: '2022-06-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose
This markdown is for extracting folds.eval and visualize the results in tables and figures.

# Dependencies
```{r}
# Dependencies
library(tidyverse)

source("function_utility.R")
source("function_evaluation.R")
```




# Load results from directory

```{r}
# Load path to eval results

#models.path <- list.files(path = "./output/cheat/") # Using all repeated measurements up to event
# Note the cheat results suffer from minor coding problems, need to rerun or simply ignore them!

# Where the folds.eval are placed
#folderpath <- "./output/comparison/" # copy folds.eval to here for selected comparison
folderpath <- "./output/" # Immediate output location of folds.eval

models.path <- list.files(path = folderpath) # Using repeated measurements up to landmark time

# Filter folds.eval files only
models.path <- models.path[grepl(pattern = "eval_", x = models.path)]

# Filter by landmark
#models.path <- models.path[grepl(pattern = "lm2", x = models.path) | grepl(pattern = "lm0", x = models.path)] # Chose landmark


models.name <- stringr::str_remove_all(stringr::str_remove_all(models.path, ".RData"), "eval_")

#models.name
```



```{r, eval=FALSE}
# Load single result


load(file = paste0(folderpath, "eval_pencal_lm2_scenario2_b5_transformed_scaled_std_ridge_seed730.RData")
folds.eval[[1]]$model.info$covariate

# print the covariates and get data dic
# data dic is not complete
temp <- get_datadic(folds.eval[[1]]$model.info$covariate$base) %>% unite(FLDNAME, TEXT, col = "new", sep = " & ") %>% select(new) %>% arrange(new)
temp2 <- get_datadic(folds.eval[[1]]$model.info$covariate$long) %>% unite(FLDNAME, TEXT, col = "new", sep = " & ") %>% select(new) %>% arrange(new)
temp3 <- temp %>% add_row(temp2)

temp3
temp3$new <- paste0(temp3$new, " \\\\")
write.csv(temp3, "./test.txt", row.names = FALSE)

```


# tdAUC

## Consolidate
```{r, fig.width=8, fig.height=4}
# ------------------------------------------------------------------------------------------------
# Summarize tdAUC results
# ------------------------------------------------------------------------------------------------

# Initialize
df.tdauc.compare <- data.frame()
T.start <- 2
deltaT <- 1:15
deltaT <- deltaT[deltaT > T.start]

is_lm <- grepl(models.name, pattern = paste0("lm", T.start))
models.name.valid <- models.name[is_lm]
models.path.valid <- models.path[is_lm]
# ------------------------------------------------------------------------------------------------

# Repeat the following steps for different models

for (i in 1:length(models.name.valid)) {
  
  name <- models.name.valid[i]
  path <- models.path.valid[i]
    
  if (i == 1) {
    # For first model to initialize dataframe
    df.tdauc <- Summarize.tdAUC(
      name = name,
      path = paste0(folderpath, path),
      detlaT = deltaT
      )
    
    df.tdauc.compare <- df.tdauc
  }

  # Result i, i > 1
  df.tdauc <- Summarize.tdAUC(
    name = name,
    path = paste0(folderpath, path),
    detlaT = deltaT
    )
  
  # Combine results from other models to compare dataframe
  df.tdauc.compare <- df.tdauc.compare %>%
    add_row(df.tdauc)
}

df.tdauc.compare %>% head()
```

```{r}
# List all models
unique(df.tdauc.compare$model.name)
```



## Compare with status.bl and without status.bl using pCox
```{r, fig.width=8, fig.height=5}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(method == "pCox-bl") %>%
  filter(!grepl(model.name, pattern = "lasso")) %>%
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model.id,
    color = factor(n_bl.covariate))
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_line(aes(linetype = scenario), size = 0.5, alpha = 0.5) +
  geom_point(aes(shape = method), alpha = 0.8) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.5, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%",
    color = "number of baseline covariates"
  )  +
  theme_minimal()
```

```{r, fig.width=8, fig.height=5}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(method == "pCox-bl") %>%
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model.id,
    color = factor(n_bl.covariate))
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_line(aes(linetype = scenario), size = 0.5, alpha = 0.5) +
  geom_point(aes(shape = method), alpha = 0.8) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.5, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%",
    color = "number of baseline covariates"
  )  +
  theme_minimal()
```

```{r}
# Print baseline covariates for each scenario
df.tdauc.compare %>%
  filter(method == "pCox-bl") %>%
  group_by(bl.covariate) %>%
  summarize(n_bl.covariate = unique(n_bl.covariate),
            scenario = unique(scenario)) %>%
  arrange(scenario) %>%
  select(scenario, everything())
```
## also include `pCox-lm` in comparison:
```{r, fig.width=8, fig.height=5}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop") %>%
  mutate(method.and.n_bl.cov = paste(method, n_bl.covariate, sep = "_")) %>%
  filter(scenario == "scenario2") %>%
  ggplot(aes(
    x = prediction_time, 
    y = repeated.CV.mean, 
    group = model.name,
    color = model.name)
  ) +
 # geom_errorbar(aes(
 #   ymax = repeated.CV.max,
 #   ymin = repeated.CV.min),
 #   alpha = 0.3,
 #   width = 0.3, size = 0.8) +
  geom_line(aes(linetype = factor(n_bl.covariate)), alpha = 0.8, size = 0.4) +
  geom_point(aes(shape = method), alpha = 0.6, size = 2.5) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.7, 1)) +
  xlab("Year from baseline") + ylab("rep CV time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under repeated 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "CV repeated in 10 different seeds",
#    caption = "Error bar represents the max and min",
    linetype = "number of (candidate) baseline covariates",
    color = "model"
  )  +
  theme_minimal()
```

```{r}
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop")
```

## Compare ridge and lasso
```{r, fig.width=8, fig.height=5}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop") %>%
  mutate(method.and.n_bl.cov = paste(method, n_bl.covariate, sep = "_")) %>%
  filter(scenario == "scenario2") %>%
  filter(method == "pCox-lm") %>%
  ggplot(aes(
    x = prediction_time, 
    y = repeated.CV.mean, 
    group = model.name,
    color = model.name)
  ) +
 # geom_errorbar(aes(
 #   ymax = repeated.CV.max,
 #   ymin = repeated.CV.min),
 #   alpha = 0.3,
 #   width = 0.3, size = 0.8) +
  geom_line(aes(linetype = factor(n_bl.covariate)), alpha = 0.8, size = 0.4) +
  geom_point(aes(shape = method), alpha = 0.6, size = 2.5) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.8, 1)) +
  xlab("Year from baseline") + ylab("rep CV time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under repeated 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "CV repeated in 10 different seeds",
#    caption = "Error bar represents the max and min",
    linetype = "number of (candidate) baseline covariates",
    color = "model"
  )  +
  theme_minimal()
```

## Compare pencal and pCox
```{r, fig.width=8, fig.height=5}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop") %>%
  mutate(method.and.n_bl.cov = paste(method, n_bl.covariate, sep = "_")) %>%
  filter(method == "pCox-lm" | method == "pencal") %>%
  filter(n_bl.covariate == 26 | n_bl.covariate == 5) %>%
  ggplot(aes(
    x = prediction_time, 
    y = repeated.CV.mean, 
    group = model.name,
    color = model.name)
  ) +
 # geom_errorbar(aes(
 #   ymax = repeated.CV.max,
 #   ymin = repeated.CV.min),
 #   alpha = 0.3,
 #   width = 0.3, size = 0.8) +
  geom_line(aes(linetype = factor(n_bl.covariate)), alpha = 0.8, size = 0.4) +
  geom_point(aes(shape = method), alpha = 0.6, size = 2.5) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.8, 1)) +
  xlab("Year from baseline") + ylab("rep CV time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under repeated 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "CV repeated in 10 different seeds",
#    caption = "Error bar represents the max and min",
    linetype = "number of (candidate) baseline covariates",
    color = "model"
  )  +
  theme_minimal()
```


```{r}
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop") %>%
  mutate(method.and.n_bl.cov = paste(method, n_bl.covariate, sep = "_")) %>%
  filter(method == "pCox-lm" | method == "pencal")
```


```{r}
df.tdauc.compare %>% 
  filter(scenario == "scenario2") %>%
  group_by(prediction_time, model.name) %>%
  summarize(repeated.CV.mean = mean(mean),
            repeated.CV.max = max(mean),
            repeated.CV.min = min(mean),
            method = unique(method),
            n_bl.covariate = unique(n_bl.covariate),
            .groups = "drop") %>%
  mutate(method.and.n_bl.cov = paste(method, n_bl.covariate, sep = "_"))
```


## Compare different baseline covariates for pCox
```{r, fig.width=6, fig.height=4}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(landmark == "lm2") %>%
  filter(method == "pCox") %>%
  filter(scenario == "scenario2") %>%
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model)
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_point(aes(shape = basecov, color = basecov), alpha = 0.8) +
  geom_line(aes(linetype = basecov, color = basecov), size = 0.5, alpha = 0.8) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.7, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%"
  )  +
  theme_minimal()
  
```

## Compare different baseline covariates for pencal at lm2, scenario2
```{r, fig.width=8, fig.height=4}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(landmark == "lm2") %>%
  filter(method == "pencal") %>%
  filter(scenario == "scenario2") %>%
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model)
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_point(aes(shape = method, color = basecov), alpha = 0.8) +
  geom_line(aes(linetype = method, color = basecov), size = 0.5, alpha = 0.8) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.7, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%"
  )  +
  theme_minimal()
  
```





## tdAUC for one scenario only:

for scenario2
```{r}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(grepl(model, pattern = "scenario2")) %>% # Comment out to show all
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model,
    color = model)
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_point() +
  geom_line(aes(linetype = method), size = 1, alpha = 0.3) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.5, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%"
  )  +
  theme_minimal()
```

for scenario0
```{r}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(grepl(model, pattern = "scenario0")) %>% # Comment out to show all
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model,
    color = model)) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
    geom_point() +
    geom_line(aes(linetype = method), size = 1, alpha = 0.3) +
    scale_x_continuous(breaks = deltaT) + 
    scale_y_continuous(breaks = 0:10 / 10) +
    coord_cartesian(ylim = c(0.5, 1)) +
    xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
    labs(
      title = "Comparison of estimated tdAUC under 10-fold CV",
      subtitle = paste("at landmark time", T.start),
      caption = "Error bar represents the pointwise interval at 2.5% and 97.5%"
    )  +
    theme_minimal()


```


## [not used] Plot scaled and MFPCCox only:
```{r, fig.width=8}
# ------------------------------------------------------------------------------------------------
# Plot df.tdauc.compare
# ------------------------------------------------------------------------------------------------
df.tdauc.compare %>%
  filter(grepl(model, pattern = "scaled")) %>% # Comment out to show all
  filter(grepl(model, pattern = "pve")) %>% # Comment out to show all
  ggplot(aes(
    x = prediction_time, 
    y = mean, 
    group = model,
    color = model)
  ) +
#  geom_errorbar(aes(
#    ymax = ci.upper,
#    ymin = ci.lower),
#    alpha = 0.3,
#    width = 0.3, size = 0.8) + 
  geom_point() +
  geom_line(aes(linetype = scenario), size = 1, alpha = 0.3) +
  scale_x_continuous(breaks = deltaT) + 
  scale_y_continuous(breaks = 0:10 / 10) +
  coord_cartesian(ylim = c(0.5, 1)) +
  xlab("Year from baseline") + ylab("time-dependent AUC\n(higher is better)") +
  labs(
    title = "Comparison of estimated tdAUC under 10-fold CV",
    subtitle = paste("at landmark time", T.start),
    caption = "Error bar represents the pointwise interval at 2.5% and 97.5%"
  )  +
  theme_minimal()
```


# C index 

## Consolidate
```{r, fig.width=8}
# ------------------------------------------------------------------------------------------------
# Summarize C-index results
# ------------------------------------------------------------------------------------------------

# Initialize
df.c.index.compare <- data.frame()
# ------------------------------------------------------------------------------------------------

for (i in 1:length(models.name)) {
  
  if (i == 1) {
    # Result 1
    df.c.index <- Summarize.c.index(
      model = models.name[i], 
      path = paste0(folderpath, models.path[i]), 
      n_fold = n_fold
      )
    
    df.c.index.compare <- df.c.index
  }

  # Result i, i > 1
  df.c.index <- Summarize.c.index(
    model = models.name[i], 
    path = paste0(folderpath, models.path[i]), 
    n_fold = n_fold
    )
  
  # Combine results from other models to compare dataframe
  df.c.index.compare <- df.c.index.compare %>%
    add_row(df.c.index)
}



```

## Plot the c-index 
```{r, fig.width=8}
# ------------------------------------------------------------------------------------------------
# Plot df.c.index.compare
# ------------------------------------------------------------------------------------------------
df.c.index.compare %>%
  filter(grepl(model, pattern = "scaled")) %>% # Comment out to show all
  filter(grepl(model, pattern = "scenario2")) %>%
  ggplot(aes(x = model, y = c.index, fill = model)) + 
    geom_point(
      aes(color = model),
      position = position_jitter(seed = 1, width = 0.2),
      alpha = 0.8) +
    geom_violin(width = 0.5, alpha = 0.2) + 
    geom_boxplot(width = 0.1, alpha = 0.2) + 
    coord_cartesian(ylim = c(0.8, 1)) +
    xlab("") + ylab("C-index") +
    labs(
      title = "Comparison of estimated C-index under single 10-fold CV",
      ) + 
    theme_minimal() +
    theme(
      axis.ticks.x = element_blank(),
      axis.text.x = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )
```

