---
title: "run_jm"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
install.packages("joineRML")
```

```{r}
library(tidyverse)

library(joineRML)
```

https://cran.r-project.org/web/packages/joineRML/vignettes/joineRML.html

https://cran.r-project.org/web/packages/joineRML/index.html

# Example from vignette

```{r}
data("heart.valve")

hvd <- heart.valve[!is.na(heart.valve$grad) & !is.na(heart.valve$lvmi), ]

```


```{r}
hvd %>% head()
```

```{r}
dim(hvd)
```

```{r}
hvd$num %>% unique() %>% length()
```



```{r}

t.start <- Sys.time()

set.seed(12345)
fit <- mjoint(
  formLongFixed = list("grad" = log.grad ~ time + sex + hs, 
                       "lvmi" = log.lvmi ~ time + sex),
  formLongRandom = list("grad" = ~ 1 | num,
                        "lvmi" = ~ time | num),
  formSurv = Surv(fuyrs, status) ~ age, # follow up years
  data = list(hvd, hvd),
  inits = list("gamma" = c(0.11, 1.51, 0.80)),
  timeVar = "time")

t.end <- Sys.time()
```




```{r}
cat("Completed in", difftime(t.end, t.start, units = "secs"), "sec")
```


# ADNI

```{r}
load("adni_cleaned_prc.RData")
```

```{r}
df.long_censored_prc %>% head()
```

```{r}
# Remove NA, why is it required?
df.long_censored_jm <- df.long_censored_prc[
  !is.na(df.long_censored_prc$ADAS13) & !is.na(df.long_censored_prc$MMSE), ]
```

//Strictly speaking, this is not necessary because joineRML can handle the situation of different measurement schedules within subjects That is, a subject does not need to have all multiple longitudinal outcomes recorded at each visit. It is conceivable that some biomarkers will be measured more or less frequently than others. For example, invasive measurements may only be recorded annually, whereas a simple biomarker measurement might be recorded more frequently. joineRML can handle this situation by specifying each longitudinal outcome its own data frame.



```{r}
t.start <- Sys.time()

fit.joineRML = mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl,
  data = list(
    df.long_censored_jm, 
    df.long_censored_jm),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()
```

```{r}
cat("Completed in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
fit.joineRML
```



# Testing different sample size

follow-up: APOE4 may need one-hot encoding, not yet scaled the variables


```{r}
# Remove NA, why is it required?
df.long_censored_jm <- df.long_censored_prc[
  !is.na(df.long_censored_prc$ADAS13) & !is.na(df.long_censored_prc$MMSE), ]
```

```{r}
# Similar size to example

set.seed(721)

ids <- df.long_censored_jm$id %>% sample(size = 200)

t.start <- Sys.time()

m.200 <- mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4,
  data = list(
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids)),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()

cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
m.200
```



```{r}
# Increase size from n=200 to n=400
set.seed(721)

ids <- df.long_censored_jm$id %>% sample(size = 400)

t.start <- Sys.time()

m.400 <- mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4,
  data = list(
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids)),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()

cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
m.400
```

## n=800

```{r}
# Increase size from n=200 to n=400
set.seed(721)

ids <- df.long_censored_jm$id %>% sample(size = 800)

t.start <- Sys.time()

m.800 <- mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4,
  data = list(
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids)),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()

cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
m.800
```



# Changing number of LMMs

```{r}
# Remove NA, why is it required?
df.long_censored_jm <- df.long_censored_prc[
  !is.na(df.long_censored_prc$ADAS13) & !is.na(df.long_censored_prc$MMSE) & !is.na(df.long_censored_prc$RAVLT.immediate), ]
```

```{r}
# Similar size to example
set.seed(721)

ids <- df.long_censored_jm$id %>% sample(size = 400)

t.start <- Sys.time()

m.400_3 <- mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup,
    "RAVLT.immediate" = RAVLT.immediate ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id,
    "RAVLT.immediate" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4,
  data = list(
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids)),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()

cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
m.400_3
```


# four time covariates

```{r}
# Remove NA, why is it required?
df.long_censored_jm <- df.long_censored_prc[
  !is.na(df.long_censored_prc$ADAS13) & !is.na(df.long_censored_prc$MMSE) & !is.na(df.long_censored_prc$RAVLT.immediate) & !is.na(df.long_censored_prc$RAVLT.learning), ]

# Similar size to example
set.seed(721)

ids <- df.long_censored_jm$id %>% sample(size = 400)

t.start <- Sys.time()

m.400_4 <- mjoint(
  formLongFixed = list(
    "ADAS13" = ADAS13 ~ age.fup, 
    "MMSE" = MMSE ~ age.fup,
    "RAVLT.immediate" = RAVLT.immediate ~ age.fup,
    "RAVLT.learning" = RAVLT.learning ~ age.fup),
  formLongRandom = list(
    "ADAS13" = ~ 1 | id, 
    "MMSE" = ~ 1 | id,
    "RAVLT.immediate" = ~ 1 | id,
    "RAVLT.learning" = ~ 1 | id),
  formSurv = Surv(time, event) ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4,
  data = list(
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids), 
    df.long_censored_jm %>% filter(id %in% ids)),
  timeVar = "Years.bl") # Did not use age.fup as time variable in LMM, due to error

t.end <- Sys.time()

cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
m.400_4
```


# Scale up
## Load data
```{r}
# Load data
# Contains two dataframes df.surv_preds and df.long_censored
load("adni_cleaned_prc.RData")

data.surv <- df.surv_preds_prc
data.long <- df.long_censored_prc

```

```{r}
count_non_na <- function(x){sum(!is.na(x))} # Count number of non-NA values in a vector

# Construct df for each covariate to inspect frequency of non-NA values per subject
res.count_non_na <- df.long_censored_prc %>% 
  group_by(id) %>% # Per subject
  dplyr::summarize(across(all_of(y.names), count_non_na)) # Count non-NA
```

```{r}
# Any subject without observation
y_any_sub_no_obs <- res.count_non_na %>% dplyr::summarise(across(all_of(y.names), function(x){any(x==0)}))

# Apply PRC without any filtering step, now works for longitudinal covariates that all subjects have at least 1 observation
y.names_subset <- y.names[y_any_sub_no_obs == FALSE]

y.names_subset
```

```{r}

```

