---
title: "pencal_test"
author: "Yibin Feng"
date: "3/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r dependencies}
library(tidyverse)
library(ggpubr)

# Uncomment to install pencal 1.0.3 instead of CRAN version, updated survpred_prcllm()
#install.packages("./package/pencal_1.0.3.tar.gz", repos = NULL, type = "source") 
library(pencal)
library(glmnet) # Step 3 output contains glmnet object

n.cores = parallel::detectCores()

print(paste("Number of cores =", n.cores))

print("Session info:")
sessionInfo()
```

# Load cleaned data

```{r}
# Contains two dataframes df.surv_preds and df.long_censored
load("adni_cleaned_prc.RData")
```

```{r}
cat("Number of subjects =", dim(df.surv_preds_prc)[1])
```

```{r, eval=FALSE}
# Check inuput formats for pencal
df.surv_preds_prc %>% select(id, time, event) %>% head() # Surv table
df.long_censored_prc %>% select(id, Years.bl) %>% head() # Long table
```

# Set up

baseline covariates:
AGE, PTGENDER, PTEDUCAT, status.bl, APOE4

time-dependent covariates:
"ADAS13", "MMSE", "RAVLT.immediate", "RAVLT.learning", "FAQ"

```{r}
# character vector with the names of the response variables which the LMMs have to be fitted to
y.names <- c("ADAS13", "MMSE", "RAVLT.immediate", "RAVLT.learning", "FAQ")

n.boots = 50 # Bootstrapping required 
#n.boots = 0 # if you do not wish to compute the CBOCP
```

## Scaling data

```{r}
#df.long_censored_prc["ADAS13"] %>% scale(center = T, scale = T)

df.long_censored_prc_scaled <- df.long_censored_prc

for (y in y.names){
  # Scaling
  df.long_censored_prc_scaled[, y] <- scale(df.long_censored_prc[, y], center = T, scale = T)
  # Check statistics after transformation
   cat("variable", y, "after scaling:",
       "\nmean =", mean(df.long_censored_prc_scaled[, y], na.rm = T),
       ", sd:", sd(df.long_censored_prc_scaled[, y], na.rm = T),
       "\n")
}
```


## Optional/testing: reduce sample size

```{r}
set.seed(721)

df.surv_preds_prc$id %>% sample(size = 100)

```

# wip chunk to test different sample size

```{r}
set.seed(721)

res_diffsize <- lapply(c(100, 200, 400), function(n){ # this function includes subseting data and then run pencal with cbocp
  
  # Subset data
  
  ids <- df.surv_preds_prc$id %>% sample(size = n) %>% unlist()
  surv_train <- df.surv_preds_prc %>% filter(id %in% ids)  
  long_train <- df.long_censored_prc_scaled %>% filter(id %in% ids)
  
  cat("\nNumber of subjects:", length(ids), "\n")
  cat("\nAvg repeated measurement per subject:", nrow(long_train) / length(ids))
  
  # Run pencal
  
  t.start <- Sys.time()

  # Step 1 of PRC-LMM: estimate the LMMs
  step1 <- fit_lmms(
    y.names = y.names,
    fixefs = ~ age.fup, # Fixed effects
    ranefs = ~ age.fup | id, # Random effects
    long.data = long_train,
    surv.data = surv_train, 
    t.from.base = Years.bl, # Name of the variable containing time from baseline in long.data
    n.boots = n.boots, 
    n.cores = n.cores)
  
  t.end <- Sys.time()
  cat("\nStep 1 completed in", difftime(t.end, t.start, units = "mins"), "min\n")
  
  t.start <- Sys.time()
  
  # Step 2 of PRC-LMM: compute the summaries
  step2 <- summarize_lmms(object = step1, n.cores = n.cores)
  
  t.end <- Sys.time()
  cat("\nStep 2 completed in", difftime(t.end, t.start, units = "mins"), "min\n")
  
  t.start <- Sys.time()
  
  # Step 3 of PRC-LMM: fit the penalized Cox models
  step3 <- fit_prclmm(
    object = step2, 
    surv.data = surv_train, 
    baseline.covs = ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4, 
    penalty = 'ridge', 
    n.cores = n.cores)
  
  t.end <- Sys.time()
  cat("\nStep 3 completed in", difftime(t.end, t.start, units = "mins"), "min\n")
  
  t.start <- Sys.time()
  
  cbocp <- performance_prc(step2, step3, 
                           times = c(1, 2, 3),
                           n.cores = n.cores)
  
  t.end <- Sys.time()
  cat("\nCBOCP completed in", difftime(t.end, t.start, units = "mins"), "min\n")
  
  return(list(n = n, cbocp = cbocp))
})



```

```{r}
res_diffsize
```

# Error diagnosis - Why some long covariate fail? 

This will not fail step 1 in pencal because every subject has at least one observation.
```{r, eval=FALSE}
# Any subject with all NA i.e. no obs?
df.long_censored_prc %>% group_by(id) %>% 
  dplyr::summarise(all_na = all(is.na(ADAS13))) %>% 
  select(all_na) %>% any()
```
Now try to run step 1 with ADAS13 to verify
```{r, eval=FALSE}
step1 <- fit_lmms(
  y.names = c("ADAS13"),
  fixefs = ~ age.fup, # Fixed effects
  ranefs = ~ age.fup | id, # Random effects
  long.data = df.long_censored_prc,
  surv.data = df.surv_preds_prc, 
  t.from.base = Years.bl, # Name of the variable containing time from baseline in long.data
  n.boots = 0, 
  n.cores = 1)
```

This will fail step 1 in pencal because some subject has no observation. When the nlme::lme() use the na.action = na.fail by default, it will fail. To remediate, use na.action = na.exclude or na.omit. NB: na.exclude differs from na.omit by remaining the same dataframe shape which is more convenient in some application.
```{r, eval=FALSE}
# Any subject with all NA i.e. no obs?
df.long_censored_prc %>% group_by(id) %>% 
  dplyr::summarise(all_na = all(is.na(FDG))) %>% 
  select(all_na) %>% any()
```
Now try to run step 1 with FDG to verify
```{r, eval=FALSE}
step1 <- fit_lmms(
  y.names = c("FDG"),
  fixefs = ~ age.fup, # Fixed effects
  ranefs = ~ age.fup | id, # Random effects
  long.data = df.long_censored_prc,
  surv.data = df.surv_preds_prc, 
  t.from.base = Years.bl, # Name of the variable containing time from baseline in long.data
  n.boots = 0, 
  n.cores = 1)
```




# Step 1 - estimate the LMMs

```{r}
t.start <- Sys.time()

# Step 1 of PRC-LMM: estimate the LMMs
step1 <- fit_lmms(
  y.names = y.names,
  fixefs = ~ age.fup, # Fixed effects
  ranefs = ~ age.fup | id, # Random effects
  long.data = df.long_censored_prc,
  surv.data = df.surv_preds_prc, 
  t.from.base = Years.bl, # Name of the variable containing time from baseline in long.data
  n.boots = n.boots, 
  n.cores = n.cores)

t.end <- Sys.time()
cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

# Step 2 - compute the summaries

```{r}
t.start <- Sys.time()

# Step 2 of PRC-LMM: compute the summaries
step2 <- summarize_lmms(object = step1, n.cores = n.cores)

t.end <- Sys.time()
cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

# Step 3 - fit the penalized Cox models

```{r}
t.start <- Sys.time()

# Step 3 of PRC-LMM: fit the penalized Cox models
step3 <- fit_prclmm(
  object = step2, 
  surv.data = df.surv_preds_prc, 
  baseline.covs = ~ AGE + PTGENDER + PTEDUCAT + status.bl + APOE4, 
  penalty = 'ridge', 
  n.cores = n.cores)

t.end <- Sys.time()
cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

# CBOCP - Cluster bootstrap optimism correction and performance measures

```{r}
t.start <- Sys.time()

cbocp <- performance_prc(step2, step3, 
                         times = c(1, 2, 3),
                         n.cores = n.cores)

t.end <- Sys.time()
cat("\nCompleted in", difftime(t.end, t.start, units = "mins"), "min")
```

```{r}
# Inspect CBOCP results
# C index estimates: 
cbocp$concordance

# time-dependent AUC estimates: 
cbocp$tdAUC
```

# Save outputs

```{r}
save(step1, step2, step3, file = "res_prc.RData")

#load("res_prc.RData")
```

# Inspect outputs

```{r, eval=FALSE}
ls(step2)

# view predicted random effects
step2$ranef.orig
```

```{r, eval=FALSE}
ls(step3)

class(step3$pcox.orig)

coef(step3$pcox.orig)

t(as.matrix(coef(step3$pcox.orig)))
```


# Predict survival probabilities

```{r}
load("adni_cleaned_prc.RData")
load("res_prc.RData")
```


Create base plot of predicted survival probabilities using train set

```{r}
# Set time steps for prediction
times.pred <- 1:10 

# Predict on train set
preds.train <- survpred_prclmm(step1, step2, step3,
                               times = times.pred) 

# Format result
res.train <- preds.train$predicted_survival %>%
  pivot_longer(cols = -id, names_to = "time") 

# Format time step label to arrange time from S(1) to S(10)
res.train$time <- res.train$time %>% factor(levels = paste0("S(", times.pred, ")")) 

# Plotting the predicted survival probability
# Using all subjects in train set
p_base <- res.train %>% ggplot() + 
  geom_line(aes(time, value, group = id),
                color = "grey", alpha = 0.5)
```

## Plot predicted survival probabilities for subset of subjects

### By survival outcome

```{r, fig.width=12, fig.height=6}
# Set time steps for prediction
times.pred <- 1:10 

plots <- lapply(c("censored", "dementia"), function(x){
  # Subset data by conditioning w.r.t. x
  new.longdata <- df.long_censored_prc %>% filter(status == x) 
  new.basecovs <- df.surv_preds_prc %>% filter(status == x) 
  
  # Predict
  preds <- survpred_prclmm(step1, step2, step3, 
                           times = times.pred,
                           new.longdata = new.longdata,
                           new.basecovs = new.basecovs)
  # Post processing
  res <- preds$predicted_survival %>%
    pivot_longer(cols = -id, names_to = "time")
  res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))
  
  # Adding the highlights to base plot
  p_base + geom_line(data = res,
    aes(time, value, group = id),
    color = "red", alpha = 0.3)  +
  labs(
    y = "Predicted survival probability",
    title = paste("Observed survival outcome =", x)
  )
})

# Combine plots
p <- ggarrange(plotlist = plots)
annotate_figure(
  p, 
  top = text_grob("Predicted survival probability", 
                  face = "bold")
  )
```

### By baseline diagnosis

```{r, fig.width=12, fig.height=6}
# Set time steps for prediction
times.pred <- 1:10 

plots <- lapply(c("CN", "MCI"), function(x){
  # Subset data by conditioning w.r.t. x
  new.longdata <- df.long_censored_prc %>% filter(status.bl == x) 
  new.basecovs <- df.surv_preds_prc %>% filter(status.bl == x) 
  
  # Predict
  preds <- survpred_prclmm(step1, step2, step3, 
                           times = times.pred,
                           new.longdata = new.longdata,
                           new.basecovs = new.basecovs)
  # Post processing
  res <- preds$predicted_survival %>%
    pivot_longer(cols = -id, names_to = "time")
  res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))
  
  # Adding the highlights to base plot
  p_base + geom_line(data = res,
    aes(time, value, group = id),
    color = "red", alpha = 0.3)  +
  labs(
    y = "Predicted survival probability",
    title = paste("Baseline diagnosis =", x)
  )
})

# Combine plots
p <- ggarrange(plotlist = plots)
annotate_figure(
  p, 
  top = text_grob("Predicted survival probability", 
                  face = "bold")
  )
```

### By APOE4

```{r, fig.width=12, fig.height=6}
# Set time steps for prediction
times.pred <- 1:10 

plots <- lapply(c(0, 1, 2), function(x){
  # Subset data by conditioning w.r.t. x
  new.longdata <- df.long_censored_prc %>% filter(APOE4 == x) 
  new.basecovs <- df.surv_preds_prc %>% filter(APOE4 == x) 
  
  # Predict
  preds <- survpred_prclmm(step1, step2, step3, 
                           times = times.pred,
                           new.longdata = new.longdata,
                           new.basecovs = new.basecovs)
  # Post processing
  res <- preds$predicted_survival %>%
    pivot_longer(cols = -id, names_to = "time")
  res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))
  
  # Adding the highlights to base plot
  p_base + geom_line(data = res,
    aes(time, value, group = id),
    color = "red", alpha = 0.3)  +
  labs(
    y = "Predicted survival probability",
    title = paste("APOE4 =", x)
  )
})

# Combine plots
p <- ggarrange(plotlist = plots, nrow = 1)
annotate_figure(
  p, 
  top = text_grob("Predicted survival probability", 
                  face = "bold")
  )
```

### By gender

```{r, fig.width=12, fig.height=6}
# Set time steps for prediction
times.pred <- 1:10 

plots <- lapply(c("Female", "Male"), function(x){
  # Subset data by conditioning w.r.t. x
  new.longdata <- df.long_censored_prc %>% filter(PTGENDER == x) 
  new.basecovs <- df.surv_preds_prc %>% filter(PTGENDER == x) 
  
  # Predict
  preds <- survpred_prclmm(step1, step2, step3, 
                           times = times.pred,
                           new.longdata = new.longdata,
                           new.basecovs = new.basecovs)
  # Post processing
  res <- preds$predicted_survival %>%
    pivot_longer(cols = -id, names_to = "time")
  res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))
  
  # Adding the highlights to base plot
  p_base + geom_line(data = res,
    aes(time, value, group = id),
    color = "red", alpha = 0.3)  +
  labs(
    y = "Predicted survival probability",
    title = paste("Gender =", x)
  )
})

# Combine plots
p <- ggarrange(plotlist = plots, nrow = 1)
annotate_figure(
  p, 
  top = text_grob("Predicted survival probability", 
                  face = "bold")
  )
```



## Individual prediction

1) randomly pick one subject from each survival outcome group
2) compare baseline covariates
3) predict
4) plot longitudinal covariates and predicted survival probabilities

```{r, fig.width=12, fig.height=6}
# Randomly pick one subject from each survival outcome group
set.seed(721)
id1 <- sample(df.surv_preds_prc %>% filter(status == "dementia") %>% select(id) %>% unlist(), size = 1)
id2 <- sample(df.surv_preds_prc %>% filter(status == "censored") %>% select(id) %>% unlist(), size = 1)

# Set the subject IDs here
show_ids <- c(id1, id2) 

# Inspect baseline covariates
df.surv_preds_prc %>% filter(id %in% show_ids) %>% select(id, time, event, status, AGE, PTGENDER, PTEDUCAT, status.bl, APOE4)

# Spaghetti plots of longitudinal covariates
# Broken lines due to NAs
plot_covariates <- c("ADAS13", "MMSE", "RAVLT.immediate", "RAVLT.learning", "FAQ")

plots <- lapply(plot_covariates, function(feature){
  df.long_censored_prc[!is.na(df.long_censored_prc[, feature]),] %>%
    filter(id %in% show_ids) %>%
    ggplot() +
      geom_point(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
      geom_line(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
    scale_y_continuous(limits = c(0, NA)) +
      labs(
        title = paste("Progression of", feature, "before event"),
        x = "Years after baseline",
        y = feature,
        color = "Subject ID",
        linetype = "Event"
      ) +
      theme(
        legend.position = "bottom"
      )
})

# Prepare subset of data as new data for prediction
new.longdata <- df.long_censored_prc %>% filter(id %in% show_ids)
new.basecovs <- df.surv_preds_prc %>% filter(id %in% show_ids) 

# Predict
preds <- survpred_prclmm(step1, step2, step3, 
                         times = times.pred,
                         new.longdata = new.longdata,
                         new.basecovs = new.basecovs)
# Post processing
res <- preds$predicted_survival %>%
  pivot_longer(cols = -id, names_to = "time")
res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))

res$id <- as.numeric(res$id)

# Adding the highlights to base plot
p <- p_base + 
  geom_point(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_line(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_text(
    data = res %>% filter(time == last(time)),
    aes(label = id,
        x = time,
        y = value + 0.04),
    size = 3
    ) +
  labs(
    y = "Predicted survival probability",
    title = paste("Predicted survival probability for selected RIDs"),
    color = "Subject ID"
    ) +
  theme(
    legend.position = ""
    )

plots[[length(plots) + 1]] <- p

# Show plots
ggarrange(plotlist = plots, ncol = 3, nrow = 2, common.legend = TRUE)
```


Subject 30 has only one observation for longitudinal covariates. But why is it having less prob to get dementia compared to subject 2?
Due to baseline diagnosis?

```{r}
df.surv_preds_prc %>% filter(id %in% c(2, 30)) %>% select(id, time, event, status, AGE, PTGENDER, PTEDUCAT, status.bl, APOE4)
```


```{r, fig.width=12, fig.height=6}
show_ids <- c(2, 30)

# Spaghetti plots of selected covariates
# Broken lines due to NAs
plot_covariates <- c("ADAS13", "MMSE", "RAVLT.immediate", "RAVLT.learning", "FAQ")

plots <- lapply(plot_covariates, function(feature){
  df.long_censored_prc[!is.na(df.long_censored_prc[, feature]),] %>%
    filter(id %in% show_ids) %>%
    ggplot() +
      geom_point(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
      geom_line(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
    scale_y_continuous(limits = c(0, NA)) +
      labs(
        title = paste("Progression of", feature, "before event"),
        x = "Years after baseline",
        y = feature,
        color = "Subject ID",
        linetype = "Event"
      ) +
      theme(
        legend.position = "bottom"
      )
})

# Prepare subset of data as new data for prediction
new.longdata <- df.long_censored_prc %>% filter(id %in% show_ids)
new.basecovs <- df.surv_preds_prc %>% filter(id %in% show_ids) 

# Predict
preds <- survpred_prclmm(step1, step2, step3, 
                         times = times.pred,
                         new.longdata = new.longdata,
                         new.basecovs = new.basecovs)
# Post processing
res <- preds$predicted_survival %>%
  pivot_longer(cols = -id, names_to = "time")
res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))

res$id <- as.numeric(res$id)

# Adding the highlights to base plot
p <- p_base + 
  geom_point(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_line(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_text(
    data = res %>% filter(time == last(time)),
    aes(label = id,
        x = time,
        y = value + 0.04),
    size = 3
    ) +
  labs(
    y = "Predicted survival probability",
    title = paste("Predicted survival probability for selected RIDs"),
    color = "Subject ID"
    ) +
  theme(
    legend.position = ""
    )

plots[[length(plots) + 1]] <- p

# Show plots
ggarrange(plotlist = plots, ncol = 3, nrow = 2, common.legend = TRUE)
```

# To be resolved

The following error appeared when only one subject is selected for prediction:

  Error in data.frame(rownames(X.new), shat.orig) : 
  arguments imply differing number of rows: 0, 1


```{r, fig.width=12, fig.height=6}
show_ids <- c(2)

# Spaghetti plots of selected covariates
# Broken lines due to NAs
plot_covariates <- c("ADAS13", "MMSE", "RAVLT.immediate", "RAVLT.learning", "FAQ")

plots <- lapply(plot_covariates, function(feature){
  df.long_censored_prc[!is.na(df.long_censored_prc[, feature]),] %>%
    filter(id %in% show_ids) %>%
    ggplot() +
      geom_point(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
      geom_line(aes(Years.bl, get(feature), group = id, color = factor(id), linetype = status),
                alpha = 0.7) +
    scale_y_continuous(limits = c(0, NA)) +
      labs(
        title = paste("Progression of", feature, "before event"),
        x = "Years after baseline",
        y = feature,
        color = "Subject ID",
        linetype = "Event"
      ) +
      theme(
        legend.position = "bottom"
      )
})

# Prepare subset of data as new data for prediction
new.longdata <- df.long_censored_prc %>% filter(id %in% show_ids)
new.basecovs <- df.surv_preds_prc %>% filter(id %in% show_ids) 

# Predict
preds <- survpred_prclmm(step1, step2, step3, 
                         times = times.pred,
                         new.longdata = new.longdata,
                         new.basecovs = new.basecovs)
# Post processing
res <- preds$predicted_survival %>%
  pivot_longer(cols = -id, names_to = "time")
res$time <- res$time %>% factor(levels = paste0("S(", times.pred, ")"))

res$id <- as.numeric(res$id)

# Adding the highlights to base plot
p <- p_base + 
  geom_point(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_line(
    data = res,
    aes(time, value, group = id, color = factor(id)), # res$id is in character, convert to numeric before factorize
    alpha = 1
    ) +
  geom_text(
    data = res %>% filter(time == last(time)),
    aes(label = id,
        x = time,
        y = value + 0.04),
    size = 3
    ) +
  labs(
    y = "Predicted survival probability",
    title = paste("Predicted survival probability for selected RIDs"),
    color = "Subject ID"
    ) +
  theme(
    legend.position = ""
    )

plots[[length(plots) + 1]] <- p

# Show plots
ggarrange(plotlist = plots, ncol = 3, nrow = 2, common.legend = TRUE)
```


