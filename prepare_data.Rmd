---
title: "Test"
author: "Yibin Feng"
date: "1/31/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install ADNIMERGE

```{r}
#install.packages("Hmisc")
#install.packages("restricted/ADNIMERGE_0.0.1.tar.gz", repos=NULL, type="source")
```

# Load package

```{r}
rm(list = ls())

library(tidyverse)

library(ADNIMERGE)
```

# Data cleaning and preprocess

Censoring:
- right censor => time, status (assumed)
- interval censor => lower, upper, status (not used)

Truncation:

## Screening
Which subjects should appear in the cleaned data?

- (visit > 1) and (DX is not Dementia at bl)
- event => Dementia at earliest time
- (right) censored => latest DX is not Dementia nor NA
- baseline covariates of interest consists non-NA, non-unknown values only

```{r}
paste("[Count] Subjects in adnimerge =", length(unique(adnimerge$RID)))
```

```{r}
# Filter subjects with only single visit i.e. no repeated measurement
ids_one_visit <- adnimerge %>%
  group_by(RID) %>%
  dplyr::summarize(n_visit = n()) %>%
  filter(n_visit == 1) %>%
  select(RID) %>%
  unlist(use.names = FALSE)

paste("[Count] Subjects with single visit only =", length(ids_one_visit))
```

```{r}
# Filter subjects without any diagnosis at baseline
ids_DXbl_NA <- adnimerge %>%
  filter(VISCODE == "bl") %>%
  filter(is.na(DX)) %>%
  select(RID) %>%
  unlist(use.names = FALSE)

paste("[Count] Subjects with DX==NA at baseline =", length(ids_DXbl_NA))
```


```{r}
# Filter subjects with Dementia diagnosis at baseline
ids_DXbl_Dem <- adnimerge %>%
  filter(VISCODE == "bl") %>%
  filter(DX == "Dementia") %>%
  select(RID) %>%
  unlist(use.names = FALSE)

paste("[Count] Subjects with DX==Dementia at baseline =", length(ids_DXbl_Dem))
```




```{r}
vars_baseline <- c("AGE", "PTGENDER", "PTEDUCAT", "PTETHCAT", "PTRACCAT", "PTMARRY", "APOE4")

# Filter subjects with NA or unknown value in baseline covariate of interest
ids_base_NA <- lapply(vars_baseline, function(x) {
  ids_NA <- adnimerge %>%
    filter(VISCODE == "bl") %>%
    filter(is.na(get(x)) | get(x) == "Unknown") %>%
    select(RID) %>%
    unlist(use.names = FALSE)
  print(paste("[Count] Subjects with NA or unknown in baseline covariate", 
              x, " =", length(ids_NA)))
  return (ids_NA)
})
```

```{r}
# Construct union of subjects to exclude
#ids_exclude <- union(union(ids_one_visit, ids_DXbl_Dem), ids_DXbl_NA)
ids_exclude <- Reduce(union, 
                      c(ids_base_NA, list(ids_one_visit, ids_DXbl_Dem, ids_DXbl_NA)))
paste("[Count] Subjects to be excluded due to single visit or DX==AD/NA at baseline =", 
      length(ids_exclude))
```

```{r}
# Subset adnimerge
df.clean <- adnimerge %>%
  filter(!(RID %in% ids_exclude))
```


```{r}
# Check DX at baseline, after screening
print("[Check] DX at baseline after screening:")
df.clean %>% 
  filter(VISCODE == "bl") %>% 
  select(DX) %>% 
  summarytools::freq()
```

## Transform categorical variables to factors

```{r}
vars_factorize <- c("PTGENDER", "PTETHCAT", "PTRACCAT", "PTMARRY", "APOE4")

for (x in vars_factorize){
  df.clean[, x] <- as.factor(df.clean[, x])
  print(paste("[Check] Levels in factor", x, 
              "--------------------------------------------------"))
  print(levels(df.clean[, x]))
}
```

## Remove double entry at time variable M

```{r}
print("[Reminder] Manual removal of RID==6014, VISCODE==m0
      due to double entry at time variable M==0,
      removed row contains NA measurement")

df.clean <- df.clean %>% 
  filter(!(RID == 6014 & VISCODE == "m0"))
```

# Convert cleaned data to survival and long data format

```{r, eval=FALSE}
# Some subjects have not enough information
# Take RID 2057 as example. There's only two visits, but last DX is NA
df.clean %>% filter(RID == 2057) %>% select(RID, DX)
# so these subjects will be dropped 
```


### df.surv: encode survival outcome and compute survival time
0=censored, 1=dementia
```{r}
# Note that we use Years.bl, which is an exact time since baseline

# Event is DX==Dementia from non-dementia at the EARLIEST follow-up time
df.dementia <- df.clean %>%
  filter(DX == "Dementia", 
         VISCODE != "bl") %>% # Dementia after baseline
  group_by(RID) %>%
  dplyr::summarize(
    time = min(Years.bl), # Earliest follow up time in years from baseline
    event = 1)

# DX==non-Dementia at LATEST follow up time
df.censored <- df.clean %>%
  filter(!(RID %in% df.dementia$RID), 
         VISCODE != "bl") %>% # Exclude subjects with event, exclude baseline
  filter(!(is.na(DX))) %>% # Non-NA, DX should be either CN or MCI
  group_by(RID) %>%
  dplyr::summarize(
    time = max(Years.bl), # Latest follow up in years from baseline
    event = 0) # Censored can be CN or MCI, at latest follow up
```


```{r, eval=FALSE}
# Check
df.dementia %>% summarytools::descr()
df.censored %>% summarytools::descr()
```


```{r}
# Merge event and censored {RID, time, status}
# Basic layout of surv data layout, without predictors
df.surv <- rbind(df.dementia, df.censored)

# Change status to factor
df.surv$status <- df.surv$event %>% 
  factor(labels = c("censored", "dementia"))

# Add baseline diagnosis e.g. CN/MCI as baseline covariate
df.surv <- df.surv %>% 
  left_join(df.clean %>% 
              filter(VISCODE == "bl") %>%
              select(RID, DX), 
            by = "RID") %>%
  mutate(status.bl = DX) %>%
  select(-DX)

# Drop dementia level in status.bl, which is not used due to previous filtering
df.surv$status.bl <- df.surv$status.bl %>% droplevels()

paste("[Count] Subjects in df.surv =", 
      df.surv %>% nrow())
paste("[Count] Subjects developed to dementia during followup =", 
      df.surv %>% filter(event == 1) %>% nrow())
paste("[Count] Subjects not developed to dementia during followup =", 
      df.surv %>% filter(event == 0) %>% nrow())
paste("[Count] overall censoring rate =", 
      1 - df.surv$event %>% mean() %>% round(3))
paste("[Check] No overlap between subjects in dementia group and censored group =", 
      identical(intersect(df.dementia$RID, df.censored$RID), numeric(0))) # TRUE is ok
```

### df.surv_preds: add predictors to survival table

```{r}
# Join cross-sectional data, measurement at baseline to surv data
# Using RID and baseline VISCODE as unique identifier
df.surv_preds <- df.surv %>%
  left_join(df.clean %>% 
              filter(VISCODE == "bl"), 
            by=c("RID"))
```


### df.long: extract long data from adnimerge

```{r}
# Construct df.long based on subjects in surv_preds

# df.long includes all measurement in adnimerge, without truncation of measurement after event
# Note that in survival analysis we only need the measurement before event, which will be prepared later
df.long <- adnimerge %>%
  filter(RID %in% df.surv$RID) 

# Add survival data
df.long <- df.long %>% 
  left_join(
    # Add surv time, outcomes, baseline status (CN/MCI/Dementia)
    df.surv_preds %>% 
      select(RID, time, event, status, status.bl), 
    by = "RID"
  )

# Compute and include age.bl (age at baseline) and age.fup (age at follow up)
df.long <- df.long %>%
  mutate(age.bl = AGE,
         age.fup = AGE + Years.bl)

# Include year based version of M, reminder: M contains integer only
df.long <- df.long %>%
  mutate(Y = M / 12)

# Rearrange column orders: {surv data}, {time vars}, {remaining}
df.long <- df.long %>%
  select(RID, time, event, status, status.bl,
         VISCODE, EXAMDATE, Years.bl, Y, Month.bl, M, Month,
         AGE, age.bl, age.fup,
         everything())
```

```{r, eval=FALSE}
# Check DX at baseline, after screening
df.long %>% 
  filter(VISCODE == "bl") %>% 
  select(DX) %>% 
  summarytools::freq()
```

### df.long_censored: remove observations at or after event

```{r}
# Prepare df.long_censored by filtering
df.long_censored <- df.long %>% 
  filter(time > Years.bl)
```

### Copy `RID` to `id` to comply with `pencal` naming convention and organization

```{r}
df.surv_preds$id <- df.surv_preds$RID
df.long_censored$id <- df.long_censored$RID

# Reorganize column order
df.surv_preds <- df.surv_preds %>% select(id, time, event, status, status.bl, everything())
df.long_censored <- df.long_censored %>% select(id, everything())

# Arrange in ascending order by id and id, age.fup
df.surv_preds <- df.surv_preds %>% arrange(id)
df.long_censored <- df.long_censored %>% arrange(id, age.fup)
```

# Save prepared datasets

```{r}
save(df.surv_preds, df.long_censored,
     file = "adni_cleaned.RData")

print("Finished data preparation for adni_cleaned.RData")

#load("adni_cleaned.RData")
```

```{r}
# Override previous process for prc only, as the process has been incorporated already
df.surv_preds_prc <- df.surv_preds
df.long_censored_prc <- df.long_censored

# Save
save(df.surv_preds_prc, df.long_censored_prc,
     file = "adni_cleaned_prc.RData")

print("Finished data preparation for adni_cleaned_prc.RData")

#load("adni_cleaned_prc.RData")
```
